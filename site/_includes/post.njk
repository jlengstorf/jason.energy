{% extends "default.njk" %}

{% block seo %}
<title>{% if seo_title %}{{seo_title}}{% else %}{{title}}{% endif %}</title>

<link rel="canonical" href="{{site }}/{{slug}}/" />
<meta name="description" content="{{description}}" />
{% if image %}<meta name="image" content="{{image | cloudinary(page.inputPath, 1200)}}" />{% endif %}

<meta property="og:type" content="article" />
<meta property="og:url" content="{{site }}/{{slug}}/" />
<meta property="og:description" content="{{description}}" />
{% if image %}<meta property="og:image" content="{{image | cloudinary(page.inputPath, 1200)}}" />{% endif %}

<meta name="twitter:dnt" content="on" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@jlengstorf" />
<meta name="twitter:title" content="{% if seo_title %}{{seo_title}}{% else %}{{title}}{% endif %}" />
<meta name="twitter:description" content="{{description}}" />
{% if image %}<meta name="twitter:image" content="{{image | cloudinary(page.inputPath, 1200)}}" />{% endif %}
{% endblock %}


{% block details %}
<div class="details">
  <figure class="author">
    <img
      src="https://res.cloudinary.com/jlengstorf/image/upload/q_auto,f_auto,c_fill,w_260,h_260,g_faces,c_fill/jason.af/jason-lengstorf-hat"
      alt="Jason Lengstorf"
    />
    <figcaption>written by Jason Lengstorf</figcaption>
  </figure>
</div>
{% endblock %}

{% block sidebar %}
<div class="sidebar">
  <div class="sticky-sidebar">
    <div class="newsletter-nudge">
      <p>
        Hey, friends! I share posts like these regularly in my
        newsletter.
        <strong
          >Sign up to get my best stuff direct to your inbox.</strong
        >
      </p>
      <a href="/newsletter/" class="button">I love stuff!</a>
    </div>

    <details class="table-of-contents" open>
      <summary>Table of Contents</summary>

      {{ content | toc | safe }}
    </details>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // footnotes
  const footnotes = document.querySelectorAll(".footnote-phrase");
  Array.from(footnotes).forEach((fnLink) => {
    fnLink.addEventListener("click", (event) => {
      event.preventDefault();

      const [, id] = event.target.href.split("#");
      const footnote = document.querySelector(`#${id} details`);

      footnote.open = !footnote.open;
    });
  });

  const footnoteCloseLinks = document.querySelectorAll(".footnote-backref");
  Array.from(footnoteCloseLinks).forEach((closeLink) => {
    closeLink.addEventListener("click", (event) => {
      event.preventDefault();

      const footnote = event.target.closest("details");
      footnote.open = false;
    });
  });

  // ToC section highlighting
  function handleIntersection(entries, observer) {
    entries.forEach((entry) => {
      if (!entry.isIntersecting) {
        return;
      }

      if (
        entry.target.offsetTop - window.pageYOffset <
        window.innerHeight - window.innerHeight * 0.1
      ) {
        const tocLinks = document.querySelectorAll(".table-of-contents a");
        Array.from(tocLinks).forEach((l) => {
          l.classList.remove("active");
        });

        document
          .querySelector(`.table-of-contents a[href$=${entry.target.id}]`)
          .classList.add("active");
      }
    });
  }

  function updateActiveToCItem() {
    const observer = new IntersectionObserver(handleIntersection, {
      rootMargin: `-${window.innerHeight * 0.33}px 0px 0px 0px`,
      threshold: [0.75, 0.8, 0.85, 0.9, 0.95, 1],
    });

    const headings = document.querySelectorAll(".content h2");
    Array.from(headings).forEach((h2) => {
      observer.observe(h2);
    });
  }

  updateActiveToCItem();
</script>
{% endblock %}
